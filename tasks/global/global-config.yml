---

###
# Convienience 
#

- name: Add ansible user to docker group
  user:
    name: "{{ ansible_user }}"
    group: docker

###
# Enable CRI plugin and set cgroup driver to systemd as per:
# https://kubernetes.io/docs/setup/production-environment/container-runtimes/#forwarding-ipv4-and-letting-iptables-see-bridged-traffic
#

- name: Remove cri from disabled plugins list
  lineinfile:
    path: /etc/containerd/config.toml
    state: absent
    line: disabled_plugins = ["cri"]

- name: Set cgroup driver to systemd
  blockinfile:
    path: /etc/containerd/config.toml
    block: |
      [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
        [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
          SystemdCgroup = true

- name: Restart containerd
  service:
    name: containerd
    state: restarted

###
# Worker nodes don't need these so disabled by default, control nodes re-enable.
#

- name: Stop/Disable VRRP/HAProxy
  become: true
  service:
    name: "{{ item }}"
    enabled: false
    state: stopped
  with_items:
    - haproxy
    - keepalived

###
# Disable swap
#

- name: Disable swap
  command: swapoff -a

- name: Remove swap ftsab entires
  lineinfile:
    path: /etc/fstab
    state: absent
    regexp: "^%swap"

###
# Setup IP Tables as per:
# https://kubernetes.io/docs/setup/production-environment/container-runtimes/#forwarding-ipv4-and-letting-iptables-see-bridged-traffic
#

- name: Ensure br_netfilter and overlay modules are loaded
  modprobe:
    name: "{{ item }}"
    state: present
  with_items:
  - br_netfilter
  - overlay

- name: Configure IP Tables
  sysctl:
    name: "{{ item }}"
    value: '1'
    state: present
  with_items:
    - net.bridge.bridge-nf-call-iptables
    - net.bridge.bridge-nf-call-ip6tables
    - net.ipv4.ip_forward

  ###
  # Make sure kubelets are using the correct node IP address
  # Needed when clustering on a system with multiple NICs
  # https://github.com/kubernetes/kubeadm/issues/203
  #

- name: Explicitly define the kubelets node ip
  become: true
  lineinfile:
    path: /etc/default/kubelet
    line: KUBELET_EXTRA_ARGS=--node-ip={{ ansible_host }}
    create: true