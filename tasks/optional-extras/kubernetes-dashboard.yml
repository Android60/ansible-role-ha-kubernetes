---
- name: Download kubernetes dashboard
  get_url:
    url: "{{ item.url }}"
    dest: "/tmp/{{ item.filename }}"
    mode: "0664"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  with_items:
    - url: https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml
      filename: kubernetes-dashboard.yml

- name: Install kubernetes dashboard
  become: false
  kubernetes.core.k8s:
    state: present
    src: "/tmp/kubernetes-dashboard.yml"

- name: Expose dashboard and create access use
  become: false
  kubernetes.core.k8s:
    state: present
    template: kubernetes-dashboard.yml.j2

- name: Get Dashboard Token
  become: false
  command: kubectl -n kubernetes-dashboard create token admin-user
  register: token

- name: Print dashboard reachability information
  debug:
    msg: "{{ item }}"
  with_items:
  - "Dashboard is now available on {{ ansible_host }}:{{ kubernetes_dashboard_port }}"
  - "{{ token.stdout }}"