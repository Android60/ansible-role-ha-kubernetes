! Configuration File for keepalived

global_defs {
    enable_script_security
    script_user "{{ ansible_user }}"
}

vrrp_script chk_haproxy {
    script "pgrep haproxy"
    interval 2
    init_fail
}

vrrp_instance {{ ansible_host }} {
    state MASTER
    interface {{ cluster_interface }}
    virtual_router_id 101
    priority {{ vrrp_pri }}
    advert_int 1
    unicast_src_ip {{ ansible_host }}
    unicast_peer {
{% for host in groups['controllers'] %}
{% if hostvars[host]['ansible_host'] !=  ansible_host  %}
        {{ hostvars[host]['ansible_host'] }}
{% endif %}
{% endfor %}
    }
    authentication {
        auth_type PASS
        auth_pass k8s_$ooPaPAzz
    }
    virtual_ipaddress {
        {{ vrrp_virtual_ip }}
    }
    track_script {
      chk_haproxy
    }
}